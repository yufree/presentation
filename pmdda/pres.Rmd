---
title: "Reproducible R-based metabolomics workflow"
subtitle: ""
author: "Miao Yu"
date: "`r Sys.Date()`"
output:
  xaringan::moon_reader:
    css: ["default", "my-theme.css", "middlebury"]
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(fig.align='center',echo = F, cache=T,message=FALSE,warning=FALSE,comment=NA)
```


## Typical workflow for HRMS metabolomics

- Collect samples

- Acquire data (peaks) using mass spectrometry

- Annotate peaks for identification with compound name

- Problems

    - Time consuming - too many peaks ~20k
    - Standards coverage - unknown unknown

---

## Quanlity control during injections

### Run order effects

- `getpqsi` function in **enviGCMS** package

```{r echo=FALSE, out.width= '50%'}
knitr::include_graphics('https://yufree.github.io/presentation/figure/pooledQC.png')
```

---

## Quanlity control during injections

### Total usable signal

```{r echo=FALSE}
library(rmwf)
data("mzrt")
TUS <- apply(mzrt$data,2,sum,na.rm=T)
runorder <- c(1:10)
plot(runorder,TUS, xlab="Run Order", ylab="TUS",pch=19)
title(main="Total Usable Signal: LQCs")
```

---

## Quanlity control during injections

### RLE plot

```{r echo=FALSE}
library(rmwf)
data("mzrt")
mzrt <- enviGCMS::getdoe(mzrt)
enviGCMS::plotridges(mzrt$data,lv=as.factor(mzrt$group$sample_group),type = 'a')
```

---
## Quanlity control during injections

### PCA

```{r}
enviGCMS::plotpca(log(mzrt$data+1),lv=as.character(mzrt$group$sample_group),col=as.numeric(as.factor(mzrt$group$sample_group)))
legend("top", horiz = T,inset=c(0, -0.2),xpd=TRUE,bty='n', legend=unique(mzrt$group$sample_group),col=unique(as.numeric(as.factor(mzrt$group$sample_group))), pch=19, title="")
```

---

## PMDDA workflow

```{r echo=FALSE,out.width = "800px"}
knitr::include_graphics('https://media.springernature.com/lw685/springer-static/image/art%3A10.1186%2Fs13321-022-00586-8/MediaObjects/13321_2022_586_Figa_HTML.png')
```

.half[
```{r refpreprint2,results = 'asis'}
doi <- c('10.1186/s13321-022-00586-8')
cat(unlist(rcrossref::cr_cn(dois = doi, format = "text", style = 'apa')))
```
]

---

## Sensitivity matters

- Target analysis could capture peaks with low intensity

- Untargeted analysis (DDA/DIA) would loss sensitivity to capture all peaks 

- Send unknown while independent peaks for MS/MS

```{r echo=FALSE,out.width = "300px"}
knitr::include_graphics('https://yufree.github.io/presentation/figure/missxcms.png')
```

---

## GlobalStd Algorithm

```{r echo=FALSE}
knitr::include_graphics('https://yufree.github.io/presentation/figure/GlobalStd.png')
```

.half[
```{r ref2,results = 'asis'}
doi <- c('10.1016/j.aca.2018.10.062')
cat(unlist(rcrossref::cr_cn(dois = doi, format = "text", style = 'apa')))
```
]

---

## PMDDA workflow

```{r echo=FALSE,out.width = "500px"}
knitr::include_graphics('https://yufree.github.io/presentation/figure/pmddacomp.png')
```

---

## Untargeted MS/MS analysis - PMDDA

```{r echo=FALSE,out.width = "87%",fig.retina = 3}
knitr::include_graphics('https://yufree.github.io/presentation/figure/rpppmdda.png')
```

???
- GNPS MS/MS annotation
- 235:59:114 PMDDS:overlap:DDA

---

## Untargeted MS/MS analysis - PMMD Annotation

- Use pmd and rank of pmd for annotation

- Intensity filter(10%) and robust for noise

- 957/1098 PMDR/HMDB QqQ data

- some compounds share the same pmd 87%


```{r echo=FALSE,out.width="400px"}
knitr::include_graphics('https://yufree.github.io/presentation/figure/pmmd.png')
```

---

## Software

### [pmd package](http://yufree.github.io/pmd/)
  
  - GlobalStd algorithm
  - pmd-reaction database based on KEGG/HMDB
  - quantitative pmd analysis
  - pmd network anaysis
  - pmd MS/MS annotation algorithm
  - GUI application based on shiny

### [rmwf package](https://github.com/yufree/rmwf)

  - NIST 1950 data 
  - Rmarkdown template
  - From raw data to report
  - part of `xcmsrocker` docker image

???
Here I show three application of reactomics and you might find more. So what I did is write a R package to include all the functions for pmd analysis or reactomics analysis such as the pmd-reaction database based on KEGG/HMDB, quantitative pmd analysis, PMD network analysis. To make it clear, I only cover the reaction between different compounds instead of reactions from one compound. However, we do have functions to make MS/MS annotation based on pmd and you could check poster 304118 for details.

Meanwhile, to make reactomics fully reproducible at the very beginning, I developed another R package called rmwf, which means reproducible metabolomics work flow. I included our lab data from NIST 1950, which is standard reference material. I included lots of R code and template to help the user to process the raw data into a report. This package is also part of xcmsrocker project, which try to creat a docker image for fully reproducible metabolomics data analysis environemnt based on RStudio.

---

class: inverse, center, middle

# Thanks 

## Q&A

## miao.yu@jax.org

```{r cache=FALSE}
knitr::knit_exit() 
```